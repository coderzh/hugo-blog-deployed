<!DOCTYPE html>
<html class="no-js">
<head>
  <base href="https://blog.coderzh.com/">
  <script>
    document._writeOriginal = document.write;
    document.write = function(str) {
        if (str.indexOf('livereload.js') > -1) {
            document._writeOriginal(str);
        } else {
            document._writeOriginal('<!-- Be Hijack!! -->');
        }
    }
  </script>
  <title>由 QuickJS 想到的 - CoderZh Blog</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="keywords" content="quickjs,">
<meta name="description" content="quickjs">
<meta name="author" content="coderzh">
<meta name="publisher" content="coderzh">
<meta name="generator" content="http://gohugo.io/"/>

<meta itemprop="name" content="由 QuickJS 想到的 - CoderZh Blog">
<meta itemprop="description" content="quickjs">
<meta itemprop="image" content="https://blog.coderzh.com/public/coderzh.jpg">

<meta property="og:title" content="由 QuickJS 想到的 - CoderZh Blog" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.coderzh.com/2019/07/14/quickjs/" />
<meta property="og:image" content="https://blog.coderzh.com/public/coderzh.jpg" />
<meta property="og:description" content="quickjs">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@coderzh">
<meta name="twitter:title" content="由 QuickJS 想到的 - CoderZh Blog">
<meta name="twitter:description" content="quickjs">
<meta name="twitter:creator" content="@coderzh">
<meta name="twitter:image" content="https://blog.coderzh.com/public/coderzh.jpg">

  <script>document.documentElement.className = document.documentElement.className.replace("no-js", "js");</script>
  <link rel="canonical" href="https://blog.coderzh.com/2019/07/14/quickjs/">
  <link rel='shortlink' href="https://blog.coderzh.com/2019/07/14/quickjs/"/>
  <link rel="shortcut icon" href="https://blog.coderzh.com/public/favicon.ico"/>
  
<link rel="stylesheet" id="human-style-css" href="https://blog.coderzh.com/wp-content/themes/hueman/style.css" type="text/css" media="all"/>
<link rel="stylesheet" id="human-style-css2" href="https://blog.coderzh.com/wp-content/themes/hueman-child/style.css" type="text/css" media="all"/>
<link rel="stylesheet" id="responsive-css" href="https://blog.coderzh.com/wp-content/themes/hueman/responsive.css" type="text/css" media="all"/>
<link rel="stylesheet" id="font-awesome-css" href="https://blog.coderzh.com/wp-content/themes/hueman/fonts/font-awesome.min.css" type="text/css" media="all"/>
<link rel="stylesheet" href="https://blog.coderzh.com/public/highlight/styles/github.css">
<script src="https://blog.coderzh.com/public/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<link rel="stylesheet" id="human-style-css3" href="https://blog.coderzh.com/wp-content/themes/hueman-child/user.css" type="text/css" media="all"/>
<link rel="stylesheet" href="public/font/hack/css/hack.min.css">

<script type="text/javascript" src="assets/js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="wp-content/themes/hueman/js/jquery.jplayer.min.js"></script>
<script type="text/javascript" src="wp-content/themes/hueman/js/scripts.js"></script>
<script type="text/javascript" src="assets/picturefill/picturefill.min.js"></script>
<script type="text/javascript" src="assets/js/jquery.matchHeight-min.js"></script>
<script type="text/javascript" async defer src="assets/js/myblog.js"></script>

</head>

<body class="single single-post single-format-standard col-3cm full-width topbar-enabled chrome">
<div id="wrapper">
  <header id="header">

  <nav class="nav-container group" id="nav-topbar">
    <div class="nav-toggle"><i class="fa fa-bars"></i></div>
    <div class="nav-text"></div>
    <div class="nav-wrap container">
      <a rel="nofollow" href="https://blog.coderzh.com/" class="nav-cs-icon">
        <img width="40" height="40" src="https://blog.coderzh.com/public/coderzh.jpg" alt="coderzh" title="Home">
      </a>
      <ul id="menu-default-menu" class="nav container-inner group">
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          <a rel="nofollow" href="https://blog.coderzh.com/">首页</a>
        </li>
        
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          <a rel="nofollow" href="https://blog.coderzh.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
        </li>
        
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          <a rel="nofollow" href="https://blog.coderzh.com/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a>
        </li>
        
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          <a rel="nofollow" href="https://blog.coderzh.com/categories/%E6%80%9D%E8%80%83%E6%84%9F%E6%82%9F/">思考感悟</a>
        </li>
        
        
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          <a rel="nofollow" href="https://blog.coderzh.com/post/">归档</a>
        </li>
        
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          <a rel="nofollow" href="https://blog.coderzh.com/about/">关于我</a>
        </li>
        
        <li class="menu-item menu-item-type-post_type menu-item-object-page">
          
        </li>
        <li class="menu-item menu-item-type-post_type menu-item-text">
        做个独立思考的程序员
        </li>
      </ul>
    </div>

    <div class="container">
      <div class="container-inner">
        <div class="toggle-search"><i class="fa fa-search"></i></div>
        <div class="search-expand">
          <div class="search-expand-inner">
            <form method="get" class="searchform themeform" action="https://www.google.com/search">
              <div>
                <input type="text" class="search" name="q" placeholder="Press enter to start searching">
              </div>
            </form>
          </div>
        </div>
      </div>
      
    </div>
    

  </nav>
  

  <div class="container group">
    <div class="container-inner">

      <div class="group pad">

        <div class="group pad">
          <h1 class="site-title">
            <a rel="nofollow" href="https://blog.coderzh.com/" rel="home">
              <img style="border-radius: 50%;width:72px;height:72px;margin:0 auto;" alt="coderzh" src="https://blog.coderzh.com/public/coderzh.jpg"></img>
              CoderZh Blog
            </a>
          </h1>
          <p class="site-description"> 如果你没有感觉到时间不够用时，你多半正在虚度光阴。 </p>
        </div>

      </div>
    </div>
    
  </div>
  

</header>



  <div class="container" id="page">
    <div class="container-inner">
      <div class="main">
        <div class="main-inner group">
          <section class="content">
            <div class="page-title pad group">
              <ul class="meta-single group">
                
                <li class="category">
                  <a href="https://blog.coderzh.com/categories/%E6%80%9D%E8%80%83%E6%84%9F%E6%82%9F/" rel="category tag">思考感悟</a>
                </li>
                
              </ul>
            </div>

            <div class="pad group">

              <article
                  class="post type-post status-publish format-standard has-post-thumbnail hentry category-australien tag-bondi-beach tag-city2surf tag-sydney">
                <div class="post-inner group">

                  <h1 class="post-title">由 QuickJS 想到的</h1>

                  <p class="post-byline">
                    by  · 2019年07月14日 · 1837 Words ·
                    ~4min reading time |
                    <a href="https://github.com/coderzh/coderzh-hugo-blog/blob/master/content/post/2019/2019-07-14-quickjs.md"
                       target="_blank">Improve on <i class="fa fa-github"></i></a>
                  </p>

                  <div class="clear"></div>

                  <div class="entry">
                    <div class="entry-inner">
                      
                      <p>前几天，一个叫 <code>Fabrice Bellard</code> 的大牛程序员发布了一个新的 JS 引擎：QuickJS，引起了业界轰动。QuickJS 的主要特点是小，嵌入式，完整支持 ES2019 语法，和其他小型嵌入式 JS 引擎比起来，速度也很快。</p>
<p>登上大牛的主页(<code>https://bellard.org</code>)，瞬间被惊呆了。原来之前耳熟能详的 FFMPEG、QEMU 都是出自他之手。还有一些之前闻所未闻的项目，据说这些都是大神的 Side Project。这些项目范围涉及之广让人瞠目，有涉及科学计算，提出最快速的计算圆周率的算法，并于 2009 年声称打破了圆周率计算的世界纪录，算出小数点后 2.7 万亿位，仅用一台普通个人计算机。有涉及编译器和虚拟机的，1996年，编写了一个简洁但是完整的 C 编译器和一个 Java 虚拟机 Harissa。发明的 TinyCC 是GNU/Linux 环境下最小的 ANSI C 语言编译器，是当前号称编译速度最快的 C 编译器。用 JavaScript 写的一个 PC 虚拟机 Jslinux。图形渲染相关 TinyGL，图片格式 BPG，等等……</p>
<p>他的个人主页也很特别，没有任何 CSS 样式，也没有一张图片，只有纯文本的项目罗列和介绍，甚至没有一点关于 <code>About Me</code> 的信息。然后，在 GitHub、Twitter、Facebook 等地方，都找不到这位神人的踪迹，不禁让人怀疑是不是一个真实存在的人，后来在 Hacker News 上有人证实了确实见过真人，更有人大声惊呼：还有 Fabrice 不能做的东西吗？看来他是一个深居简出，沉浸在代码世界而不受外界干扰的大神级程序员。</p>
<p>这让我更加有兴趣去拜读一下他的代码了。QuickJS 的主页介绍简单明了，代码直接是一个压缩包，名字里带着创建的日期：<code>quickjs-2019-07-09.tar.xz</code>。这大概是我在十几年前常见的代码共享的方式，而现在已经 2019 年了，大神也没有选择 GitHub 之类的开源协作的平台，甚至让我怀疑他开发过程中是不是有使用 git 之类的源代码管理工具。大神总是特立独行的，直接丢一个压缩包，大概是在说：这就是我所有代码了，有任何问题和疑问，直接给我发邮件吧，不接受任何社交媒体联系方式。</p>
<p>我隐约觉得我的关注重点应该还是他的代码，而不是他的人，也许他本人也是这么认为的。代码解压后，代码是用 C89 写的，不是 C++，甚至不是 C99。这大概是一种技术偏执，在 C 和 C++ 中选择 C 的神级程序员也不在少数，比如开发了 skynet 的云风，还有游戏引擎大牛 Andre Weissflog。在 Andre 的 twitter 上，他贴了一条自己的编程语言使用历程：</p>
<pre><code>Z80 asm =&gt; 68k asm =&gt; pre-C89 =&gt; post-C89 =&gt; C++98 =&gt; C++11 =&gt; C99
</code></pre>
<p>经历过 C++11 的各种便利和绚丽，最后还是返璞归真的选择了 C99，或许也给我带来了一些深层的思考：什么才是程序的本质。和 Fabrice 不同，Andre 是一个社交型程序员，甚至使得我有一种感觉，他整天都在发 twitter，但发现他的代码居然一行也没有少写。</p>
<p>这样看来 Fabrice 选择 C89，也没有什么让人奇怪的地方了。代码解压后，自然是先编译一通。没有用 CMake，只有 MakeFile，嗯，一点问题也没有，大概我们都是被 CMake 惯坏了吧，离了它几乎都不懂得怎样编译代码了。大神总是以一种最原始最直接的方式，去组织和掌控着一切。在 linux 上，直接 make 编译，不用多长时间就顺利编过了。</p>
<p>据说 Fabrice 是从 2017 年开启的这个 Side Project，现在的我看他的代码，由如管中窥豹，只能看到一些粗浅的东西，更多东西还得花时间细细研读。但就 QuickJS 而言，在目前的版本里，它是没有 JIT 的，所以和 Google 的 V8 性能比起来，还是有很大差距的。它将一段 JS 代码编译生成一个可执行二进制的方式，是先将 JS 编译成字节码，然后将字节码嵌入到一段 c 的代码里，然后解释执行这段字节码。</p>
<p>比如，hello.js 代码：</p>
<pre><code class="language-js">console.log(&quot;Hello World&quot;);
</code></pre>
<p>经过 qjsc 编译后，会生成一个这样的 hello.c 代码：</p>
<pre><code class="language-c">/* File generated automatically by the QuickJS compiler. */

#include &quot;quickjs-libc.h&quot;

const uint32_t hello_size = 87;

const uint8_t hello[87] = {
 0x01, 0x04, 0x0e, 0x63, 0x6f, 0x6e, 0x73, 0x6f,
 0x6c, 0x65, 0x06, 0x6c, 0x6f, 0x67, 0x16, 0x48,
 0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x57, 0x6f, 0x72,
 0x6c, 0x64, 0x22, 0x65, 0x78, 0x61, 0x6d, 0x70,
 0x6c, 0x65, 0x73, 0x2f, 0x68, 0x65, 0x6c, 0x6c,
 0x6f, 0x2e, 0x6a, 0x73, 0x0d, 0x00, 0x02, 0x00,
 0x9e, 0x01, 0x00, 0x01, 0x00, 0x03, 0x00, 0x00,
 0x14, 0x01, 0xa0, 0x01, 0x00, 0x00, 0x00, 0x38,
 0xc4, 0x00, 0x00, 0x00, 0x42, 0xc5, 0x00, 0x00,
 0x00, 0x04, 0xc6, 0x00, 0x00, 0x00, 0x27, 0x01,
 0x00, 0xd2, 0x2b, 0x8e, 0x03, 0x01, 0x00,
};

int main(int argc, char **argv)
{
  JSRuntime *rt;
  JSContext *ctx;
  rt = JS_NewRuntime();
  ctx = JS_NewContextRaw(rt);
  JS_AddIntrinsicBaseObjects(ctx);
  js_std_add_helpers(ctx, argc, argv);
  js_std_eval_binary(ctx, hello, hello_size, 0);
  js_std_loop(ctx);
  JS_FreeContext(ctx);
  JS_FreeRuntime(rt);
  return 0;
}
</code></pre>
<p>所有相关的 opcode 可以在 quickjs-opcode.h 里找到。最核心的 quickjs.c 有 47842 行。作为一个完整的 JS 引擎，代码已经是相当的精炼了，活生生的一本教科书。不过，现在的 QuickJS 在性能要求高的场景和 V8 还是没有可比性，希望这个东西不仅仅是大神闲暇之余的玩具，期待之后能带来更大的惊喜吧。</p>
<p>有人说， Fabrice 就是 10x Engineer，即工作效率相当于 10 个程序员。立马有人站出来反对，分明是 100x Engineer 嘛。这个世界就是这样，有些人比你聪明，比你有天赋，工作效率是你的 10 倍，同时还比你努力。当你在上班划水时，他在写代码，你在吃鸡落地成盒，他又调通了一个核心模块。</p>

                      
                    </div>
                    <div style="border: 1px dashed #e0e0e0; padding: 10px 10px 10px 10px; background-color: #fffeee; background-repeat: no-repeat; background-attachment: scroll; background-position: 1% 50%; -moz-background-size: auto auto; -moz-background-clip: -moz-initial; -moz-background-origin: -moz-initial; -moz-background-inline-policy: -moz-initial;">
                        <div style="float:left;margin-top:0px;">
                        <img src="https://blog.coderzh.com/public/qrcode.jpg" width="129px" height="129px"/>
                        <div style="text-align:center;">微信扫一扫交流</div>
                        </div>
                        <div>
                            <p style="margin-top:0px;">作者：<a target="_blank" href="http://blog.coderzh.com/">CoderZh</a>
                            <br />微信关注：hacker-thinking （程序员思考者）
                            <br />本文出处：<a target="_blank" href="https://blog.coderzh.com/2019/07/14/quickjs/">https://blog.coderzh.com/2019/07/14/quickjs/</a>
                            <br />
                            文章版权归本人所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。 </p>
                        </div>
                    </div>
                    <div class="clear"></div>
                  </div>
                  

                </div>
                
              </article>
              
              <div class="clear"></div>
              
              
              
            </div>
          </section>
          <div class="sidebar s1">
  <a class="sidebar-toggle" title="Expand Sidebar"><i class="fa icon-sidebar-toggle"></i></a>
  <div class="sidebar-content">
    <div class="sidebar-top group">
      <p>Follow:</p>
      <ul class="social-links">
    <li>
    <a class="social-tooltip" title="On WeiBo"
        href="http://weibo.com/coderzh" target="_blank">
        <i class="fa fa-weibo"></i>
    </a>
    </li>
    <li>
    <a class="social-tooltip" title="On Twitter" rel="nofollow"
        href="https://twitter.com/coderzh" target="_blank">
        <i class="fa fa-twitter"></i>
    </a>
    </li>
    <li>
    <a class="social-tooltip" title="On GitHub"
        href="https://github.com/coderzh" target="_blank">
        <i class="fa fa-github"></i>
    </a>
    </li>
</ul>

    </div>
    <div class="widget qrcode">
    <img src="https://blog.coderzh.com/public/qrcode.jpg" alt="qrcode" width="172px" height="172px"/>
    <p> 微信扫一扫：<br/> 关注我的公众号： <br /> hacker-thinking <br /></p>
</div>

    <ul class="post-nav group">
      <li class="next">
        
        <a href="https://blog.coderzh.com/2020/02/03/my-2019/" rel="next">
          <i class="fa fa-chevron-right"></i>
          <strong>Next post</strong>
          <span>我的 2019</span>
        </a>
        
      </li>
      <li class="previous">
        
        <a href="https://blog.coderzh.com/2019/04/01/gdc2019/2/" rel="prev">
          <i class="fa fa-chevron-left"></i>
          <strong>Previous Post</strong>
          <span>GDC2019小记（二）</span>
        </a>
        
      </li>
    </ul>
    <div id="search-2" class="widget widget_search"><h3>Search</h3>
      <form method="get" class="searchform themeform" action="https://www.google.com/search">
        <div>
          <input type="text" class="search" name="q" placeholder="Press enter to start searching">
        </div>
      </form>
    </div>
  </div>
  
</div>

          <div class="sidebar s2">
  <a class="sidebar-toggle" title="Expand Sidebar"><i class="fa icon-sidebar-toggle"></i></a>
  <div class="sidebar-content">
    <div class="sidebar-top group">
      <p>More</p>
    </div>
    <div id="categories-2" class="widget widget_categories"><h3>Categories</h3>
      <ul>
        
          <li class="cat-item cat-item-1">
            <a rel="nofollow" href="https://blog.coderzh.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
          </li>
        
          <li class="cat-item cat-item-1">
            <a rel="nofollow" href="https://blog.coderzh.com/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/">技术文章</a>
          </li>
        
          <li class="cat-item cat-item-1">
            <a rel="nofollow" href="https://blog.coderzh.com/categories/%E6%80%9D%E8%80%83%E6%84%9F%E6%82%9F/">思考感悟</a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

        </div>
      </div>
    </div>
  </div>
  <footer id="footer">
  <section class="container" id="footer-bottom">
    <div class="container-inner">
      <a id="back-to-top" href="#"><i class="fa fa-angle-up"></i></a>
      <div class="pad group">
        <div class="grid one-half">
          <div id="copyright">
              <p>Copyright (c) 2017. All rights reserved.  <a href='http://www.miitbeian.gov.cn/'>粤ICP备17074587号-1</a><br>Powered by
              <a rel="nofollow" href="http://gohugo.io/" target="_blank">Hugo - the static site generator</a>.
              <a rel="nofollow" href="http://golang.org" target="_blank">#golang</a>.
            </p>
          </div>
          
        </div>
        
        <div class="grid one-half last">
          <ul class="social-links">
    <li>
    <a class="social-tooltip" title="On WeiBo"
        href="http://weibo.com/coderzh" target="_blank">
        <i class="fa fa-weibo"></i>
    </a>
    </li>
    <li>
    <a class="social-tooltip" title="On Twitter" rel="nofollow"
        href="https://twitter.com/coderzh" target="_blank">
        <i class="fa fa-twitter"></i>
    </a>
    </li>
    <li>
    <a class="social-tooltip" title="On GitHub"
        href="https://github.com/coderzh" target="_blank">
        <i class="fa fa-github"></i>
    </a>
    </li>
</ul>

        </div>
      </div>

    </div>
    
  </section>
  
</footer>

</div>

</body>
</html>

